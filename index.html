<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#38bdf8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alpha Remover – Versione Funzionante</title>
<style>
body{margin:0;font-family:system-ui;background:#0f172a;color:#e5e7eb}
header{padding:14px;text-align:center;font-size:22px;font-weight:700;color:#38bdf8}
main{padding:12px;max-width:900px;margin:auto}
button,select,input{width:100%;padding:12px;margin:6px 0;border-radius:12px;border:none;font-size:16px}
button{background:#38bdf8;color:#020617;font-weight:700}
canvas{width:100%;border-radius:14px;background:#020617;touch-action:none;display:block}
.checkbox-group{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  justify-content:space-between;
}
.checkbox-group label{
  display:flex;
  align-items:center;
  gap:8px;
  background:#1e293b;
  padding:8px 12px;
  border-radius:10px;
  flex:1 1 45%;
  min-width:120px;
  box-sizing:border-box;
  font-weight:600;
  cursor:pointer;
}
.checkbox-group input[type="checkbox"]{
  width:20px;
  height:20px;
  margin:0;
  accent-color:#38bdf8;
}
.progress{background:#1e293b;border-radius:12px;overflow:hidden;height:26px}
.progress-bar{height:100%;width:0%;background:#38bdf8;color:#020617;display:flex;align-items:center;justify-content:center;font-weight:700}
#debug{background:#020617;border:1px solid #38bdf8;border-radius:12px;padding:10px;font-size:12px;height:180px;overflow:auto;white-space:pre-wrap}
</style>
</head>
<body>
<header>Alpha Remover – Versione Funzionante</header>
<main>
<input type="file" id="fileInput" accept="image/*">
<canvas id="preview"></canvas>
<button id="analyze">Analizza immagine</button>
<div id="analysis"></div>
<div class="checkbox-group">
<label><input type="checkbox" data-min="1" data-max="51" checked> Alpha 1–51</label>
<label><input type="checkbox" data-min="52" data-max="102" checked> Alpha 52–102</label>
<label><input type="checkbox" data-min="103" data-max="153" checked> Alpha 103–153</label>
<label><input type="checkbox" data-min="154" data-max="204" checked> Alpha 154–204</label>
<label><input type="checkbox" data-min="205" data-max="254" checked> Alpha 205–254</label>
</div>
<button id="apply">Aggiorna anteprima (COMMIT)</button>
<div class="progress"><div class="progress-bar" id="bar">0%</div></div>
<h3>Debug realtime</h3>
<div id="debug"></div>
<input type="text" id="name" placeholder="Nome immagine">
<select id="scale">
<option value="1">Originale</option>
<option value="2">x2</option>
<option value="4">x4</option>
</select>
<button id="download">Download PNG</button>
<button id="fullscreen">Visualizzazione a schermo intero</button>
<div id="fullscreenContainer" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;touch-action:none">
<canvas id="fullscreenCanvas" style="width:100%;height:100%;"></canvas>
</div>
<script>
const fileInput=document.getElementById('fileInput');
const canvas=document.getElementById('preview');
const ctx=canvas.getContext('2d',{willReadFrequently:true});
const analysis=document.getElementById('analysis');
const debug=document.getElementById('debug');
const bar=document.getElementById('bar');
const applyBtn=document.getElementById('apply');
const downloadBtn=document.getElementById('download');
const nameInput=document.getElementById('name');
const scaleSelect=document.getElementById('scale');
const fullscreenBtn=document.getElementById('fullscreen');
const fullscreenContainer=document.getElementById('fullscreenContainer');
const fullscreenCanvas=document.getElementById('fullscreenCanvas');
const fsCtx=fullscreenCanvas.getContext('2d',{willReadFrequently:true});
const checkboxes=[...document.querySelectorAll('.checkbox-group input')];

let img=null;
let buffer=null; 
let original=null;

function log(msg){debug.textContent+=msg+"\n";debug.scrollTop=debug.scrollHeight;}

fileInput.addEventListener('change',e=>{
 const file=e.target.files[0];
 if(!file)return;
 img=new Image();
 img.onload=()=>{
  canvas.width=img.width;
  canvas.height=img.height;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.drawImage(img,0,0);
  original=ctx.getImageData(0,0,canvas.width,canvas.height);
  buffer=new ImageData(new Uint8ClampedArray(original.data),original.width,original.height);
  analysis.textContent='';
  bar.style.width='0%'; bar.textContent='0%';
  log('Immagine caricata: '+img.width+'x'+img.height);
 };
 img.src=URL.createObjectURL(file);
});

document.getElementById('analyze').addEventListener('click',()=>{
 if(!buffer){log('Nessuna immagine da analizzare');return;}
 const counts={};
 for(let i=3;i<buffer.data.length;i+=4){
   const a=buffer.data[i];
   counts[a]=(counts[a]||0)+1;
 }
 const display=[];
 checkboxes.forEach(c=>{
   const min=Number(c.dataset.min), max=Number(c.dataset.max);
   let cnt=0;
   for(let k=min;k<=max;k++) if(counts[k]) cnt+=counts[k];
   display.push(`Alpha ${min}-${max}: ${cnt.toLocaleString()}`);
 });
 display.push(`Alpha 0: ${counts[0] ? counts[0].toLocaleString() : 0}`);
 display.push(`Alpha 255: ${counts[255] ? counts[255].toLocaleString() : 0}`);
 analysis.innerHTML=display.join('<br>');
 log('Analisi completata.');
});

applyBtn.addEventListener('click',()=>{
 if(!buffer){log('Nessuna immagine da aggiornare');return;}
 const d=buffer.data;
 const total=d.length/4;
 let modified=0;
 for(let i=0;i<total;i++){
   const idx=i*4+3;
   const a=d[idx];
   if(a===0||a===255) continue;
   let keep=false;
   for(const c of checkboxes){
     const min=Number(c.dataset.min), max=Number(c.dataset.max);
     if(a>=min && a<=max){ keep=c.checked; break; }
   }
   const newA=keep?255:0;
   if(d[idx]!==newA){d[idx]=newA; modified++;}
   if(i%10000===0){
     const perc=Math.floor((i/total)*100);
     bar.style.width=perc+'%';
     bar.textContent=perc+'%';
   }
 }
 ctx.putImageData(buffer,0,0);
 bar.style.width='100%'; bar.textContent='100%';
 log('COMMIT completato. Pixel modificati: '+modified.toLocaleString());
});

downloadBtn.addEventListener('click',()=>{
 if(!buffer){log('Nessuna immagine da scaricare'); return;}
 const s=Number(scaleSelect.value);
 const out=document.createElement('canvas');
 out.width=buffer.width*s;
 out.height=buffer.height*s;
 const outCtx=out.getContext('2d');
 outCtx.putImageData(buffer,0,0);
 if(s>1){
   const temp=outCtx.getImageData(0,0,buffer.width,buffer.height);
   outCtx.clearRect(0,0,out.width,out.height);
   outCtx.save();
   outCtx.scale(s,s);
   outCtx.putImageData(temp,0,0);
   outCtx.restore();
 }
 const a=document.createElement('a');
 a.download=(nameInput.value||'alpha-remover')+'.png';
 a.href=out.toDataURL('image/png');
 a.click();
 log('PNG scaricato');
});

fullscreenBtn.addEventListener('click',()=>{
 if(!buffer) return;
 fullscreenContainer.style.display='block';
 fullscreenCanvas.width=window.innerWidth;
 fullscreenCanvas.height=window.innerHeight;
 let offsetX=0, offsetY=0, scale=1;
 let lastX=0,lastY=0,lastDist=0;
 fsCtx.setTransform(1,0,0,1,0,0);
 fsCtx.clearRect(0,0,fullscreenCanvas.width,fullscreenCanvas.height);
 fsCtx.drawImage(canvas,0,0);

 function getDistance(touches){ const dx=touches[0].clientX-touches[1].clientX; const dy=touches[0].clientY-touches[1].clientY; return Math.hypot(dx,dy); }

 fullscreenCanvas.ontouchstart=e=>{
   e.preventDefault();
   if(e.touches.length===1){ lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; }
   else if(e.touches.length===2){ lastDist=getDistance(e.touches); }
 };
 fullscreenCanvas.ontouchmove=e=>{
   e.preventDefault();
   if(e.touches.length===1){
     const dx=e.touches[0].clientX-lastX; const dy=e.touches[0].clientY-lastY;
     offsetX+=dx; offsetY+=dy; lastX=e.touches[0].clientX; lastY=e.touches[0].clientY;
   } else if(e.touches.length===2){
     const newDist=getDistance(e.touches);
     const centerX=(e.touches[0].clientX+e.touches[1].clientX)/2;
     const centerY=(e.touches[0].clientY+e.touches[1].clientY)/2;
     const scaleFactor=newDist/lastDist; scale*=scaleFactor;
     offsetX=centerX-(centerX-offsetX)*scaleFactor; offsetY=centerY-(centerY-offsetY)*scaleFactor; lastDist=newDist;
   }
   fsCtx.setTransform(scale,0,0,scale,offsetX,offsetY);
   fsCtx.clearRect(-offsetX/scale,-offsetY/scale,fullscreenCanvas.width/scale,fullscreenCanvas.height/scale);
   fsCtx.drawImage(canvas,0,0);
 };
 fullscreenCanvas.ontouchend=e=>{ if(e.touches.length<2) lastDist=0; if(e.touches.length===0) lastX=lastY=0; };
 fullscreenContainer.onclick=()=>{ fullscreenContainer.style.display='none'; };
});

// Registrazione Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered', reg))
      .catch(err => console.log('SW registration failed', err));
  });
}
</script>
</body>
</html>